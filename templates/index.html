<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chesso</title>
  <link href="/static/img/chesspieces/wikipedia/bQ.png" rel="icon" type="image/x-icon" />
  <link href="static/css/bootstrap.min.css" rel="stylesheet" />
  <link href="static/css/styles.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboard2@0.5.0/dist/chessboard2.min.css"
    integrity="sha384-47VeTDpmy4yT21gKPXQcLQYQZwlmz27gEH5NTrOmTk3G/SGvMyltclOW/Q8uE+sL" crossorigin="anonymous">
</head>

<body>
  <div class="wrapper d-flex flex-column min-vh-100">
    <h1 class="title">Chesso</h1>
    <div class="flex-fill d-flex justify-content-center align-items-center board-section flex-wrap">
      <div id="board" class="chessboard"></div>
      <div class="info-panel d-flex flex-column justify-content-between align-items-center">
        <div class="flex-grow-1 d-flex flex-column justify-content-start align-items-start w-100 px-3 py-2">
          <div id="status" class="mb-2"></div>
          <div id="pgn-container" class="pgn-box w-100">
            <div id="pgn"></div>
          </div>
        </div>
        <div class="button-row d-flex w-100">
          <button id="flip-button" class="btn btn-outline-light flex-fill">Flip</button>
          <button id="newgame-button" class="btn btn-outline-light flex-fill">New</button>
          <button id="move-button" class="btn btn-outline-light flex-fill">Move</button>
          <select id="depth-select" class="btn depth-select flex-fill">
            <option value="1">D1</option>
            <option value="2">D2</option>
            <option value="3">D3</option>
            <option value="4" selected>D4</option>
            <option value="5">D5</option>
            <option value="6">D6</option>
            <option value="7">D7</option>
            <option value="8">D8</option>
          </select>
        </div>
      </div>
    </div>
    <div class="top-links">
      <a href="https://github.com/macsimbodnar/chesso" class="top-link" id="engine-link" target="_blank"
        rel="noopener noreferrer">Engine Github</a>
      <a href="https://github.com/macsimbodnar/chess_server" class="top-link" id="web-link" target="_blank"
        rel="noopener noreferrer">Server Github</a>
    </div>
  </div>

  <script src="static/js/jquery-3.5.1.min.js"></script>
  <script src="static/js/bootstrap.min.js"></script>
  <script src="https://unpkg.com/@chrisoakman/chessboard2@0.5.0/dist/chessboard2.min.js"
    integrity="sha384-/KwQCjA1GWovZNV3QDVtvSMDzO4reGgarF/RqHipr7hIUElH3r5zNl9WEPPOBRIF"
    crossorigin="anonymous"></script>

  <script type="module">
    import { Chess } from "/static/js/chess.js"

    let board;
    let game = new Chess();
    let is_flipped = false;
    let selected_depth = 4;

    function updateStatus() {
      let status = '';
      let moveColor = game.turn() === 'w' ? 'White' : 'Black';

      if (game.in_checkmate()) {
        status = 'Game over, ' + moveColor + ' is in checkmate.';
      } else if (game.in_draw()) {
        status = 'Game over, drawn position.';
      } else {
        status = moveColor + ' to move';
        if (game.in_check()) status += ', ' + moveColor + ' is in check';
      }

      $('#status').text(status);
      $('#pgn').text(game.pgn());
    }

    function makeComputerMove() {
      $.ajax({
        url: '/make_move',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
          fen: game.fen(),
          depth: selected_depth.toString(),
          time: "0"
        }),
        success: function (response) {
          game.move(response.best_move, { sloppy: true });
          board.position(game.fen());
          updateStatus();
        },
        error: function (xhr, status, error) {
          console.error('Engine move error:', error);
        }
      });
    }
    function onDragStart(context) {
      const piece = context.piece;
      const source = context.square;

      if (game.game_over()) return false;

      if ((game.turn() === 'w' && piece.startsWith('b')) ||
        (game.turn() === 'b' && piece.startsWith('w'))) {
        return false;
      }

      // ✅ Clear the piece from the source square to avoid duplication
      const newPosition = { ...board.position() };
      delete newPosition[source];
      board.position(newPosition);
    }


    function onDrop({ source, target, piece }) {
      const move = game.move({ from: source, to: target, promotion: 'q' });

      if (move === null) {
        return 'snapback'; // invalid move → snap back
      }

      board.position(game.fen()); // manually update position
      updateStatus();
      setTimeout(makeComputerMove, 100);

      return 'drop'; // prevent default animation
    }

    function onSnapEnd() {
      board.position(game.fen());
    }

    $(document).ready(function () {
      board = Chessboard2('board', {
        draggable: true,
        position: 'start',
        onDragStart: onDragStart,
        onDrop: onDrop,
        onSnapEnd: onSnapEnd
      });

      $('#flip-button').on('click', function () {
        is_flipped = !is_flipped;
        board.flip();
      });

      $('#depth-select').on('change', function () {
        selected_depth = parseInt(this.value);
      });

      $('#newgame-button').on('click', function () {
        game.reset();
        board.position('start');
        updateStatus();
      });

      $('#move-button').on('click', function () {
        makeComputerMove();
      });

      $(window).on('resize', function () {
        board.resize();
      });

      updateStatus();
    });
  </script>
</body>

</html>